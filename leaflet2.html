<!DOCTYPE html>
<html class="ocks-org do-not-copy">
<meta charset="utf-8">
<title>D3 + Leaflet</title>
<style>

/*@import url(//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css);*/
@import url(//cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.2/leaflet.css);

#map {
  /*width: 960px;*/
  height: 500px;
}

svg {
  position: relative;
}

/*path {
  fill-opacity: .5;
  stroke: #fff;
  stroke-width: 1px;
}*/

path:hover {
  fill-opacity: .8;
}

path.leaflet-clickable:hover {
  fill-opacity: .5;
}

path.leaflet-clickable,
.leaflet-zoom-animated {
	pointer-events: none;
}

path:focus {
  fill-opacity: .8;
}

/* Change cursor when mousing over clickable layer */
.leaflet-clickable {
  cursor: crosshair !important;
}
/* Change cursor when over entire map */
.leaflet-container {
  cursor: crosshair !important;
}

.d3-tip {
  position: absolute;
  pointer-events: none;
}

</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>  
<script src="js/stat_zg_generals.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.2/leaflet.js"></script>
<link rel="stylesheet" type="text/css" href="https://www.zg.ch/behoerden/baudirektion/statistikfachstelle/customstyles_css?ts=" />
<script type="text/javascript" src="/behoerden/baudirektion/statistikfachstelle/daten/js/libraries/jquery.slinky.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.62.0/dist/L.Control.Locate.min.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.62.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>

<h1>Kleinräumige Analyse</h1>

<p>Wie ist die Bevölkerung in Ihrer näheren Umgebung zusammengesetzt?</p>
<!--<div id = 'control' class='controlBar'>
    <ul class="subelements-listing" id="controlUL">
      <li id='Total Einwohner' class='selected'><a href="javascript:;">Einwohner/innen</a></li>
      <li id='Durchschnittsalter' class=''><a href="javascript:;">Durchschnittsalter in Jahren</a></li>
      <li id='Anteil Katholiken' class=''><a href="javascript:;">Anteil Katholik/innen</a></li>
      <li id='Anteil Schweizer Nationalität' class=''><a href="javascript:;">Anteil Personen mit Schweizer Nationalität</a></li>
      <li id='Anteil 65 Jahre und mehr' class=''><a href="javascript:;">Anteil 65-Jahre und mehr</a></li>
    </ul>
</div>-->

<div class="slincky-wrapper">
	<section>
		<p>Wählen Sie das Thema</p>
		<div id="menu" class="slinky-menu">
			<ul>
				<li><h2>Themenbereich (bitte wählen)</h2></li>
				<li><a href="javascript:;" class='selection selected' id="Total Einwohner/innen">Anzahl Einwohner/innen</a></li>
				<li>
					<a href="#">Geschlecht</a>
					<ul>
						<li><a href="javascript:;" class='selection' id="Anteil Männer">Anteil Männer</a></li>
						<li><a href="javascript:;" class='selection' id="Anteil Frauen">Anteil Frauen</a></li>
					</ul>
				</li>
				<li>
					<a href="#">Alter</a>
					<ul>
						<li><a href="javascript:;" class="selection" id="Durchschnittsalter">Durchschnittsalter</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil 65 Jahre und mehr">Anteil 65 Jahre und mehr</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil unter 18">Anteil unter 18</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil unter 10">Anteil unter 10</a></li>
					</ul>
				</li>
				<li>
					<a href="#">Zivilstand</a>
					<ul>
						<li><a href="javascript:;" class="selection" id="Anteil Ledige">Anteil Ledige</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil Verheiratete">Anteil Verheiratete</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil Geschiedene">Anteil Geschiedene</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil Verwittwete">Anteil Verwittwete</a></li>
					</ul>
				</li>
				<li>
					<a href="#">Nationalität</a>
					<ul>
						<li><a href="javascript:;" class="selection" id="Anteil mit Schweizer Nationalität">Anteil mit Schweizer Nationalität</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil ohne Schweizer Nationalität">Anteil ohne Schweizer Nationalität</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil mit Europäischer Nationalität">Anteil mit Europäischer Nationalität</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil ohne Europäische Nationalität">Anteil ohne Europäische Nationalität</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil in der Schweiz geboren">Anteil in der Schweiz geboren</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil nicht in der Schweiz geboren">Anteil nicht in der Schweiz geboren</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil in Europa geboren">Anteil in Europa geboren</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil nicht in Europa geboren">Anteil nicht in Europa geboren</a></li>
						<li><a href="javascript:;" class="selection" id="Durchschnittlicher Wohndauer in der Schweiz (nur aus dem Ausland Zugezogene)">Durchschnittlicher Wohndauer in der Schweiz (nur aus dem Ausland Zugezogene)</a></li>
					</ul>
				</li>

				<li>
					<a href="#">Wohndauer im Ort</a>
					<ul>
						<li><a href="javascript:;" class="selection" id="Anteil seit Geburt im Ort Wohnhaft">Anteil seit Geburt im Ort Wohnhaft</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil zugezogen seit 2000">Anteil zugezogen seit 2000</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil zugezogen seit 2014">Anteil zugezogen seit 2014</a></li>
					</ul>
				</li>
				<li>
					<a href="#">Religion</a>
					<ul>
						<li><a href="javascript:;" class="selection" id="Anteil katholisch">Anteil katholisch</a></li>
						<li><a href="javascript:;" class="selection" id="Anteil reformiert">Anteil reformiert</a></li>
					</ul>
				</li>
			</ul>
		</div>
	</section>

</div>

<script>
	$(document).ready(function() {
		$('#menu').slinky({
			title: true,
			label: "Zurück",
			
		});
	});
</script>
<h1 id="main-title">Anzahl Einwohner/innen</h1>
<p id="map"></p>
<p id="source">Datenquelle: Bundesamt für Statistik, STATPOP 2017</p>
<script>

var map = new L.Map("map", {center: [47.15626713, 8.51612091], 
		zoom: 11, 
		minZoom: 10,
		maxZoom: 18,
		zoomSnap: 0,
		zoomDelta: 0.25,
		wheelPxPerZoomLevel: 100})
	.addLayer(new L.TileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png", {attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attribution">CARTO</a>'}));	

	L.control.scale({imperial:false}).addTo(map);
	
var svg = d3.select(map.getPanes().overlayPane).append("svg"),
    g = svg.append("g").attr("class", "leaflet-zoom-hide").attr("id", "hexbin-container");
	
d3.json("geojson/hexbin-STATPOP.geojson", function(error, collection) {
	if (error) throw error;

	var variable = 'Total Einwohner/innen';
  
	var transform = d3.geo.transform({point: projectPoint}),
		path = d3.geo.path().projection(transform);

	var feature = g.selectAll("path")
		.data(collection.features)
		.enter().append("path");

	var hexcoloring = d3.scale.linear()
		.domain([-1, -0.5, 0, 0.5, 1])
		.range(['#007AC4','#00A763','#FFDD5E','#FF8A26','#ff403a']);
		
	var maxquote=Number(d3.max(collection.features, function(d) { return d.properties[variable]; }));
	var minquote=Number(d3.min(collection.features, function(d) { return d.properties[variable]; }));
		
	function calibrate(num) {
		return ((num-minquote)/(maxquote-minquote)*2)-1
	}
		
	var div = d3.select("body").append("div")
		.attr("class", "d3-tip n")
		.attr("id", "d3-tip")
		.style("display", "none");
		
	function mouseover(d) {
		//console.log("mouseover");
		div.style("display", "inline");
	}

	function mousemove(d) {
		//console.log("mousemove");
		div.style("display", "inline");
		if (variable=="Total Einwohner/innen") {
			var text= variable + ": " + germanFormatters.numberFormat(",")(d3.select(this).datum().properties[variable]);
		}
		else {
			if (variable=="Durchschnittlicher Wohndauer in der Schweiz (nur aus dem Ausland Zugezogene)" || variable=="Durchschnittsalter") {wert=germanFormatters.numberFormat(",.1f")(d3.select(this).datum().properties[variable]) + " Jahre"}
			else {wert=germanFormatters.numberFormat(",.1%")(d3.select(this).datum().properties[variable])}
			var text= variable + ": " + wert + "<br/>" + "Total Einwohner/innen" + ": " + germanFormatters.numberFormat(",")(d3.select(this).datum().properties["Total Einwohner/innen"]);
		}
		
		div
			.html(text)
			.style("left", function(d){return (d3.event.pageX) + "px"})
			.style("top", (d3.event.pageY) + "px");
		
		$("#d3-tip").css("border-left", hexcoloring(calibrate(d3.select(this).datum().properties[variable])) +" solid 5px");
		offsetx=(Number($("#d3-tip").css( "left" ).slice(0, -2)) - 17 - ($("#d3-tip").width()/2));
		offsety=(Number($("#d3-tip").css( "top" ).slice(0, -2)) - 40 - ($("#d3-tip").height()));
		$("#d3-tip").css( 'left', offsetx);
		$("#d3-tip").css( 'top', offsety);
	}

	function mouseout(d) {
		//console.log("mouseout");
		div.style("display", "none");
	}
	
	function drawHex() {
	
		maxquote=Number(d3.max(collection.features, function(d) { return d.properties[variable]; }));
		minquote=Number(d3.min(collection.features, function(d) { return d.properties[variable]; }));
  
		feature.attr('style', 'pointer-events:visiblePainted;');
		
		feature.style("fill", function(d) {
			return hexcoloring(calibrate(d.properties[variable]));
		});
		feature.style("visibility", function (d) {
			return d.properties[variable] != null ? "visible" : "hidden";
		});
		feature.style("fill-opacity", 0.5)
			.style("stroke", "#fff")
			.style("stroke-width", "1px");
		
		map.on("zoom", reset);
		map.on("move", reset);
		//Notwendig für Mobile-Devices, damit, dass Tooltip nicht falsch positioniert wird.
		map.on("zoom", mouseout);
		map.on("move", mouseout);
		reset();
		
		feature.on("mouseover", mouseover)
			.on("mousemove", mousemove)
			.on("mouseout", mouseout)
			.on("click", mousemove)
			;
		
		d3.selectAll("#scale").remove()
		
		//Skala hinzufügen
		scalecontainer = d3.select("#map").append("svg")
		.attr("id", "scale")
		.attr("height", "220px")
		.attr("width", "60px")
		.style("margin-top", "100px")
		.style("margin-left", "10px")
		.style("pointer-events", "none");
	
		y = d3.scale.linear()
		.domain([maxquote, minquote])
		.range([0, 0.4*500])
		
		gradient = scalecontainer.append('svg:linearGradient')
			.attr('id', 'gradient')
			.attr("x1", "100%")
			.attr("y1", "100%")
			.attr("x2", "100%")
			.attr("y2", "0%")
			.attr("spreadMethod", "pad")
			
		gradient.append('svg:stop')
			.attr('stop-color', function(d) { return hexcoloring(-1) })
			.attr('offset', '0')
		
		gradient.append('svg:stop')
			.attr('stop-color', function(d) { return hexcoloring(-0.5) })
			.attr('offset', '0.25')
		
		gradient.append('svg:stop')
			.attr('stop-color', function(d) { return hexcoloring(0) })
			.attr('offset', '0.5')
			
		gradient.append('svg:stop')
			.attr('stop-color', function(d) { return hexcoloring(0.5) })
			.attr('offset', '0.75')
		
		gradient.append('svg:stop')
			.attr('stop-color', function(d) { return hexcoloring(1) })
			.attr('offset', '1')
			
		scalecontainer
			.datum({min: minquote, max: maxquote })
			.append('svg:rect')
				.attr('id', 'gradient-bar')
				.attr('fill', 'url(#gradient)')
				.attr('fill-opacity', 0.7)
				.attr('width', function(d) { return 10 })
				.attr('height', 0.4*500)
				.attr("transform", "translate(0,10)")
		
		var axis = d3.svg.axis()
			.scale(y)
			.orient("right")
			.tickValues([minquote, (maxquote-minquote)/4+minquote, (maxquote-minquote)/2+minquote, (maxquote-minquote)/4*3+minquote, maxquote]);
		
		if (variable=="Total Einwohner/innen") {
			axis.tickFormat(germanFormatters.numberFormat(",.0f"));
		}
		else if (variable=="Durchschnittlicher Wohndauer in der Schweiz (nur aus dem Ausland Zugezogene)" || variable=="Durchschnittsalter") {
			axis.tickFormat(germanFormatters.numberFormat(",.1f"));
		}
		else {
			axis.tickFormat(d3.format(".1%"));
		}
		
		scalecontainer.append('g').attr('class', 'axis')

		scalecontainer.selectAll('.axis')
			.attr('transform', 'translate(10,10)')
			.call(axis)
			
	}
	
	drawHex();

	// Reposition the SVG to cover the features.
	function reset() {
		//console.log("reset");
		var bounds = path.bounds(collection),
			topLeft = bounds[0],
			bottomRight = bounds[1];
			
		svg.attr("width", bottomRight[0] - topLeft[0])
			.attr("height", bottomRight[1] - topLeft[1])
			.style("left", topLeft[0] + "px")
			.style("top", topLeft[1] + "px");

		g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

		feature.attr("d", path);
	}

	// Use Leaflet to implement a D3 geometric transformation.
	function projectPoint(x, y) {
		var point = map.latLngToLayerPoint(new L.LatLng(y, x));
		this.stream.point(point.x, point.y);
	}
  
	function changeInd() {
		mouseout();
	/*	d3.select('.subelements-listing').selectAll('li')
		    .attr('cursor', 'pointer')
		    .on('click', function() {
		        if (this.className == 'selected') {
		            console.log('schon gewählt');
		        } else {
		            d3.select('.subelements-listing').selectAll('li').attr('class', '');
		            this.className = 'selected';
		            variable = d3.select(this).attr('id');
					console.log(variable);
					drawHex();
		        }
		    });*/
		d3.select('#menu').selectAll('a.selection')
		    .attr('cursor', 'pointer')
		    .on('click', function() {
				if (this.className == 'selection selected') {
		            console.log('schon gewählt');
		        } else {
					d3.select('#menu').selectAll('a.selection').attr('class', 'selection');
		            this.className = 'selection selected';
		            variable = d3.select(this).attr('id');
					console.log(variable);
					drawHex();
					$("#main-title").text(variable);
		        }
		    });
	}
	
	changeInd();
	
	L.control.locate({
		circleStyle: {
			stroke: true,
			color: "#007AC4",
			weight: 2,
			fillColor: "#ffffff",
			fillOpacity: 0.3
		},
		showPopup: false
	}).addTo(map);
	
	map.on('zoomstart zoom zoomend', function(ev){
		console.log('Zoom level: ' + map.getZoom());
	})
	
});

</script>
